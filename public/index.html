<!DOCTYPE html>
<html>
<head>
  <title>Morning Face Attendance</title>
  <script defer src="https://cdn.jsdelivr.net/npm/face-api.js"></script>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body>

<h1>Morning Face Attendance</h1>

<h3 id="liveCount">Total Present Today: 0</h3>

<h2>Register Student</h2>
<input id="studentId" placeholder="Student ID">
<input id="name" placeholder="Name">
<button onclick="registerFace()">Register Face</button>

<h2>Live Camera Attendance</h2>
<video id="video" width="400" height="300" autoplay muted></video>

<script>
const video = document.getElementById("video");
const socket = io("http://localhost:5000");

socket.on("attendanceUpdate", (data) => {
  document.getElementById("liveCount").innerText =
    "Total Present Today: " + data.totalPresent;
});

async function loadModels() {
  await faceapi.nets.tinyFaceDetector.loadFromUri('/models');
  await faceapi.nets.faceLandmark68Net.loadFromUri('/models');
  await faceapi.nets.faceRecognitionNet.loadFromUri('/models');
}

async function startVideo() {
  const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
  video.srcObject = stream;
}

async function getDescriptor() {
  const detection = await faceapi
    .detectSingleFace(video, new faceapi.TinyFaceDetectorOptions())
    .withFaceLandmarks()
    .withFaceDescriptor();

  if (!detection) return null;
  return Array.from(detection.descriptor);
}

async function registerFace() {
  const descriptor = await getDescriptor();
  if (!descriptor) return alert("No face detected");

  const studentId = document.getElementById("studentId").value;
  const name = document.getElementById("name").value;

  await fetch("/student/register", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ studentId, name, descriptor })
  });

  alert("Face Registered");
}

async function recognizeLoop() {
  const descriptor = await getDescriptor();
  if (!descriptor) return;

  await fetch("/attendance/face-mark", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ descriptor })
  });
}

async function startSystem() {
  await loadModels();
  await startVideo();
  setInterval(recognizeLoop, 4000);
}

startSystem();
</script>

</body>
</html>
